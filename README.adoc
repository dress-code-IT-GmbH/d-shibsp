# Shibboleth SP docker image  

A Shibboleth configuration running apache httpd and shibd in a container:

1. Mapping users (apache and shibd) between host & container filesystems (useful in a shared process namespace)
2. The user-defined network uses static IP addresses
3. Image is based on centos7
4. The image produces immutable containers, i.e. a container can be removed and re-created
   any time without loss of data, because data is stored on mounted volumes
5. The express configuration uses a single YAML file to setup a shibboleth SP.

## Prepare the repository

    git clone https://github.com/identinetics/docker-shib-sp.git
    cd docker-shib-sp
    git submodule update --init
    

## Build the docker image

    cp conf.sh.default conf.sh
    # edit conf.sh: set SERVICEDESCRIPTION, IMGID,
    ./dscripts/build.sh 


## Configure and start the container
 
First, start the container with a shell.
This will initialize the persistent docker volumes without starting the services.

    ./dscripts/run.sh -ip bash 

Then configure httpd and shibboleth (see next section).
Once the configuration is completed run `/start.sh` in the container, or restart the container:

    ./dscripts/run.sh              # start container in daemon mode
    ./dscripts/manage.sh logs      # show container stdout and stderr
    ./dscripts/manage.sh logfiles  # list log files as configured in conf.sh

### Configuration Options

There are several good guides for a general Shibboleth SP available, such as on shibboleth.net and switch.ch.
As an alternative this repository includes an express configuration for the SP.
By editing setup_shibsp.yaml a basic configuration can be controlled from a single place.
The setup can be run only once after creating persistent docker volumes. Manual editing afterwards is possible.
To prepare the express setup, edit `/opt/install/config/setup_shibsp.yaml', then run

    /opt/install/scripts/setup_config.sh


## Shibboleth SP further Configuration

Check/modify the config files in /etc/shibboleth according to the documentation, in particular:

  - attribute-map.xml and attribute-policy.xml
  - register /etc/shibboleth/export/sp_metadata.xml at the federation resource registry


### Duplicating/migrating an existing configuration

An existing configuration might be duplicated on the same or migrated to another node.

- copy conf.sh (or confXX.sh to confYY.sh on the same node)
- edit conf.sh and set the IMGID and PROJSHORT
- dscripts/build.sh (this will also create the docker volumes)
- the default path for the volumes is $DOCKER_VOLUME_ROOT/$CONTAINERNAME, here in short VOLROOT
- copy the contents of the docker volumes from the existing instance
- edit VOLROOT/.etc_httpd_conf/httpd.conf and correct the user
- set servername, docroot and logfile path in VOLROOT/.etc_httpd_conf.d/vhost.conf
- Adapt shibboleth2.xml, attribute-map.xml and attribute-policy.xml in VOLROOT.etc_shibboleth/ 
- create a new sp key and metadata:
 
    `dscripts/run.sh -i  # start container in interactive mode`
    `cd /etc/shibboleth; ./keygen.sh -f`
    `chown shibd-user sp-*`
    `metagen.sh`
    
- edit metadata and submit it to the metadata feed
- copy the metadata signing key to VOLROOT.etc_shibboleth/metadata_crt.pem (as defined in shibboleth2.xml)
- edit static contents in VOLROOT.var_www
- Besides the SP configuration the load balancer, TLS-certificate and DNS-name need to be configured